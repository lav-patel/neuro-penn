---
title: "Neuro comorbidity"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(DT)
# library(gghighlight)

theme_set(theme_bw() + 
            theme(legend.title = element_blank(),
                  panel.grid.minor = element_blank()))
for (r_file in list.files('R/', full.names = TRUE)) source(r_file)
```

```{r nwu}
# demo_raw <- read.csv("../../Phase2.1/Date_Shifted_Files/LocalPatientSummary_Shift.csv")
# obs_raw <- read.csv("../../Phase2.1/LocalPatientObservations.csv")
```

```{r message=FALSE}
# labs_raw <- read_csv('../thrombotic-penn/data/labs_long_thrombo_v2.csv')
# clin_raw <- read_csv(
#   '../thrombotic-penn/data/LocalPatientClinicalCourseSHIFTED-UPenn.csv',
#   col_types = list(patient_num = col_character()))
demo_raw <- read_csv(
  '../thrombotic-penn/data/LocalPatientSummarySHIFTED-UPenn.csv',
  col_types = list(patient_num = col_character()))
obs_raw <- read_csv(
  '../thrombotic-penn/data/LocalPatientObservations-UPenn.csv',
  col_types = list(patient_num = col_character()))
```

```{r message=FALSE, warning=FALSE}
loinc <- read_csv('public-data/penn-loinc-map.csv')
neuro_icds_10 <- read_excel('public-data/2020-09-10_neuro-icd10.xlsx') %>% 
  rename('icd' = `ICD-10`)

```

## Data pre-processing

In this initial analysis, we will consider neuro patients as those with a neuro code on the day **of** or **anytime after** their first day of admission.

Only examining ICD-10 for now.

*Note: We will need to discuss whether we want to include codes assigned on the day of admission as comorbidities.*

How do we define "neuro patients"?
Patients with prior neurological conditions?
Patients who developed neurological conditions after COVID-19 related admission

(using after admission for now...)

The `all_neuro_pats` vector contains neuro patients regardless of whether or not they have a comorbidity/data prior to admission.

```{r}
n_patients <- nrow(demo_raw)
obs_raw <- obs_raw %>% 
  filter(concept_type %in% c("DIAG-ICD10", "DIAG-ICD9"))

all_neuro_pats <- obs_raw %>% 
  # filter(days_since_admission >= 0) %>% 
  right_join(neuro_icds_10, by = c('concept_code' = 'icd')) %>% 
  pull(patient_num) %>% 
  unique()

length(all_neuro_pats)
```

New variable `neuro_post` to indicate whether the patient developed neurological conditions after COVID-19 related admission.

Q: What about on the day of?

```{r}
demo_processed <- obs_raw %>%
  mutate(neuro_prior_icd = 
           days_since_admission > 0 & 
           patient_num %in% all_neuro_pats) %>% 
  group_by(patient_num) %>% 
  summarise(neuro_post = any(neuro_prior_icd),
            .groups = 'drop') %>% 
  left_join(demo_raw, by = 'patient_num')

neuro_pt_post <- demo_processed %>% 
  filter(neuro_post) %>% 
  pull(patient_num) %>% 
  unique()

length(neuro_pt_post)
```

## Map comorbidities

List of comorbidity abbreviations for reference purposes,
then run the `map_charlson_codes()` function:

```{r}
comorb_names <- get_comorb_names()

# where num_day_since_admission = -1 indicates that we only consider codes prior to the first COVID admission as comorbidities
comorb <- map_charlson_codes(data = obs_raw, 
                             comorb_names = comorb_names, 
                             num_days_since_admission = -1)
```

`map_charlson_codes()` outputs a 2-element lists: 

<!-- 1- Dataframe indicating which comorbidities were mapped -->

1- Dataframe of the Charlson comorbidity index scores

2- Dataframe of the specific mapped codes arranged by frequency.
Comorbidity mapping of all patients with ICD codes prior to admission, regardless of whether or not they had a comorbidity.

```{r}
index_scores <- comorb$index_scores
mapped_codes_table <- comorb$mapped_codes_table
```

## Table 1

to display the % of patients mapped to each comorbidity.
The table will include side by side comparison of the comorbidity mappings fo the full patient cohort and neuro patient cohort for those who had prior neuro ICD Codes:

```{r}
comorb_names$Abbreviation <- as.character(comorb_names$Abbreviation)

combined_table1 <- get_table1(
  index_scores %>% filter(patient_num %in% neuro_pt_post)) %>% 
  rename('n_neuro_pats' = n_patients) %>% 
  left_join(get_table1(index_scores), .,
            by = c("Comorbidity", "Abbreviation")) %>% 
  mutate(prop_patients = n_patients/nrow(demo_raw),
         prop_neuro_pats = n_neuro_pats/nrow(demo_raw))

datatable(combined_table1) %>% 
  formatPercentage(c('prop_patients', 'prop_neuro_pats'))

write.csv(combined_table1, "results/table1_combined.csv", row.names = FALSE)
```


```{r fig.width=10}
mapped_codes_table %>% 
  filter(n_patients > 5) %>% 
  ggplot(aes(x = concept_code, y = Abbreviation, fill = n_patients)) +
  geom_tile() +
  scale_fill_gradient(low = 'white', trans = "sqrt") +
  labs(x = NULL, y = NULL) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90))
```

Here we can determine how many unique patients we have ICD codes for prior to admission:
```{r}
length(unique(index_scores$patient_num))
```

## Comorbidity matrix

The following code will print the comorbidity matrix with a subset of patients (n)
```{r}
index_scores %>% 
  select(MI:HIV) %>% 
  cor() %>% 
  heatmap()

icd_plot <- index_scores %>% 
  select(MI:HIV) %>% 
  pivot_longer(everything()) %>% 
  filter(value != 0) %>% 
  left_join(comorb_names, c('name' = 'Abbreviation')) %>% 
  mutate(fullname = glue::glue('{Comorbidity} ({name})'))

icd_plot %>% 
  count(fullname) %>% 
  ggplot(aes(x = n, y = fct_reorder(fullname, n))) +
  geom_col() +
  labs(y = NULL)

index_scores %>% 
  pivot_longer(MI:HIV) %>% 
  filter(value != 0) %>% 
  left_join(comorb_names, c('name' = 'Abbreviation')) %>% 
  mutate(fullname = glue::glue('{Comorbidity} ({name})')) %>% 
  ggplot(aes(x = charlson_score, y = fct_reorder(fullname, charlson_score))) +
  geom_boxplot() +
  labs(y = NULL)
```


## Charlson scores

### Distribution

The below code will join the comorbidity mappings and the neurological code information, basic demographic and hospital mortality information into one dataframe.

```{r}
demo_processed$patient_num <- as.character(demo_processed$patient_num)
obs_raw$patient_num <- as.character(obs_raw$patient_num)

scores_unique <- index_scores %>% 
  left_join(demo_processed, by = 'patient_num') %>% 
  mutate(severe = as.factor(severe) %>% 
           fct_recode('Severe' = '1', 'Non-severe' = '0'))

scores_neuro <- obs_raw %>% 
  # 1 patient can have different code but each only counted once
  distinct(patient_num, concept_code) %>% 
  left_join(neuro_icds_10, by = c('concept_code' = 'icd')) %>% 
  left_join(scores_unique, by = 'patient_num') %>% 
  filter(!is.na(charlson_score)) %>% 
  mutate(`Neurological Disease Category` =
           as.factor(`Neurological Disease Category`) %>% 
           fct_reorder(charlson_score),
         concept_code = as.factor(concept_code) %>% 
           fct_reorder(- charlson_score)) %>% 
  {.}

scores_unique %>% 
  ggplot(aes(x = charlson_score, fill = neuro_post)) +
  geom_histogram(binwidth = 1) +
  NULL

scores_unique %>% 
  ggplot(aes(x = neuro_post, y = charlson_score, fill = neuro_post)) + 
  geom_boxplot(outlier.colour = NA) + 
  geom_jitter(alpha = 0.2, width = 0.2, size = 0.6) +
  NULL
```

### Median and IQR

```{r}
aggregate(charlson_score ~ neuro_post, FUN = "median", scores_unique)
aggregate(charlson_score ~ neuro_post, FUN = "summary", scores_unique)
```


### Compared to Quan scoring system
```{r}
scores_unique %>% 
  ggplot(aes(x = quan_score, y = charlson_score)) +
  geom_jitter(alpha = 0.2, size = 0.3) +
  coord_fixed() +
  geom_abline(slope = 1, color = 'lightgrey', linetype = 'dashed')
cor(scores_unique$charlson_score, scores_unique$quan_score)
```


### Correlated variables
```{r}
lm(charlson_score ~ neuro_post + severe + deceased, # + sex + age_group + race,
   data = scores_unique) %>% 
  summary()
```

### By neuro diagnosis

Here we will use the `obs_processed` dataframe in contrast to our `scores_unique` dataframe as the former is in long format
```{r}
# scores$patient_num <- as.numeric(as.character(scores$patient_num))
scores_neuro %>% 
  filter(neuro_post, 
         !is.na(charlson_score), 
         !is.na(`Neurological Disease Category`)) %>% 
  ggplot(aes(y = concept_code, x = charlson_score, fill = concept_code)) + 
  facet_grid(rows = vars(`Neurological Disease Category`),
             scales = 'free', space = 'free') +
  geom_boxplot(alpha = 0.6) + 
  scale_fill_viridis_d(guide = FALSE, direction = -1) +
  labs(x = 'Charlson score', y = NULL) +
  NULL +
  theme(panel.grid = element_blank(),
        legend.title = element_text(),
        strip.text.y = element_text(angle = 0),
        panel.spacing.x = unit(10, "points"),
        panel.spacing.y = unit(0, "points"))
```

### By grouped neuro diagnosis and severity

How would we interpret this figure?

```{r}
scores_neuro %>% 
  ggplot(aes(
    y = reorder(`Neurological Disease Category`, - charlson_score, na.rm = TRUE), 
    x = charlson_score, fill = severe)) + 
  geom_boxplot() + 
  labs(x = 'Charlson score', y = NULL) +
  scale_fill_manual(name = NULL, 
                    values = c("gray", "darkorange"),
                    guide = guide_legend(reverse = TRUE)) +
  NULL
```

### Neuro vs non-neuro patients

```{r}
comorb_long <- scores_unique %>% 
  select(patient_num, neuro_post, charlson_score, MI:HIV) %>% 
  pivot_longer(MI:HIV) %>% 
  filter(value == 1)

comorb_long %>% 
  mutate(neuro_post = as.factor(neuro_post) %>% 
           fct_recode('Neuro' = 'TRUE', 'Non-neuro' = 'FALSE')) %>% 
  ggplot(aes(
    y = reorder(name, - charlson_score, na.rm = TRUE), 
    x = charlson_score, fill = neuro_post)) + 
  geom_boxplot() + 
  labs(x = 'Charlson score', y = NULL) +
  scale_fill_manual(values = c("gray", "slateblue"),
                    guide = guide_legend(reverse = TRUE)) +
  NULL
```

## Neuro condition vs comorbidity type

```{r}
comorb_wilcox_func <- function(comorb, df = comorb_long) {
  df <- df %>% filter(name == comorb)
  neuro <- df %>% filter(neuro_post == 1)
  non_neuro <- df %>% filter(neuro_post == 0)
  wilcox.test(neuro$charlson_score, non_neuro$charlson_score)$p.value
}

comorbs <- comorb_names$Abbreviation

wilcox_res <- comorbs %>%
  sapply(comorb_wilcox_func, df = comorb_long) %>%
  data.frame(p_value = .) %>%
  cbind(comorbs) %>%
  arrange(p_value)

wilcox_res

median_list <- list()
for (i in comorbs) {
  df <- comorb_long %>% filter(name == i)
  median_list[[i]] <- 
    aggregate(charlson_score ~ neuro_post, FUN = "summary", df) %>% 
    as.data.frame()
}
median_list = do.call(rbind, median_list)
list_names <- row.names(median_list)

m1 <- median_list[[1]]
m2 <- median_list[[2]]
median_list <- cbind(m1, m2)
row.names(median_list) <- list_names
colnames(median_list)[1] <- "Neuro"
median_list
```

Q: Do we need `median_list`?

## Additional Notes:

Neuro Codes: G04, G45, G46, I60, 161, 162, and 167 will map to comorbidities.
An important consideration is that we don't want to confuse comorbidities for complications of hospital stay/COVID-19

The below will assess how many on these neuro comorbidity codes occurred on the day of admission and how many neuro codes in general are on the day of admission.

*Note: This is just for data exploration right now, we are going to initially just assume that any codes prior to the COVID-19 admission are comorbidities*
```{r}
neuro_comorb_codes <- c("G04", "G45", "G46",  # paralysis codes
                        "I60", "161", "162", "167") # stroke codes

neuro_comorb_on_admission <- obs_raw %>%
  filter(days_since_admission == 0) %>%
  filter(concept_code %in% neuro_comorb_codes) %>%
  select(patient_num, concept_code) %>%
  distinct()
unique(neuro_comorb_on_admission$concept_code)
```

## Comorbidities timeframe

Qs: When are these comorbidities getting mapped 
```{r}
# considers only codes at least -15 days prior to admission as comorbidities
comorb15 <- map_charlson_codes(obs_raw, comorb_names, -15) 

# considers code day of admission as comorbidities
comorb0 <- map_charlson_codes(obs_raw, comorb_names, 0) 

# map only day of admission
obs_raw0 <- obs_raw %>% filter(days_since_admission == 2)
comorb_dayOf <- map_charlson_codes(obs_raw0, comorb_names, 2) 
```

## Comorbidities Overtime
```{r}
index_scores_dayOf <- comorb_dayOf$index_scores
mapped_codes_dayOf <- comorb_dayOf$mapped_codes_table

dayOf_table1 <- get_table1(
  index_scores_dayOf %>% filter(patient_num %in% neuro_pt_post)) %>% 
  rename('n_neuro_pats' = n_patients) %>% 
  left_join(get_table1(index_scores_dayOf), .,
            by = c("Comorbidity", "Abbreviation"))
```

```{r}
plot_list <- list()
for (i in comorb_names$Abbreviation) {
  plot_list[[i]] <- comorb_time(obs_raw, mapped_codes_table, i, -365)
} 
```

## First occurence of a comorbidity 
```{r}
obs_first <- obs_raw %>% 
  group_by(patient_num) %>% 
  merge(mapped_codes_table, by = "concept_code") %>%
  arrange(days_since_admission) %>%
  group_by(patient_num, Abbreviation) %>%
  filter(days_since_admission == min(days_since_admission)) %>%
  slice(1L) %>%
  ungroup() %>%
  select(-Abbreviation) # to be able to re-run the plot function

plot_list <- list()
for (i in comorb_names$Abbreviation) {
  plot_list[[i]] <- comorb_time(obs_first, mapped_codes_table, i, -365)
} 
```


